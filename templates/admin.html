<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard Pro</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="admin-body">
    
    <div class="admin-layout">
        <div class="sidebar">
            <h2 style="margin-bottom: 40px;">PAINEL<span style="color: var(--accent);">ADMIN</span></h2>
            <button class="nav-btn active" onclick="openTab(event, 'dashboard')"><i class="fas fa-chart-line"></i> Dashboard</button>
            <button class="nav-btn" onclick="openTab(event, 'chat')"><i class="fas fa-comments"></i> Chat Ao Vivo</button>
            <button class="nav-btn" onclick="openTab(event, 'leads')"><i class="fas fa-users"></i> Leads</button>
            <button class="nav-btn" onclick="openTab(event, 'financeiro')"><i class="fas fa-wallet"></i> Financeiro</button>
            <button class="nav-btn" onclick="openTab(event, 'reviews')"><i class="fas fa-star"></i> Avaliações</button>
            
            <div style="margin-top: auto;">
                <button id="theme-toggle" class="theme-btn" style="width:100%; margin-bottom:10px;"><i class="fas fa-moon"></i> Tema</button>
                <a href="/logout" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Sair</a>
            </div>
        </div>

        <div class="main-content">
            
            <div class="filters" style="background: var(--admin-card-bg); padding: 15px; border-radius: 10px; display: flex; gap: 10px; margin-bottom: 25px; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                <form method="GET" style="display: flex; gap: 10px; flex: 1;">
                    <input type="text" name="q" placeholder="Buscar..." style="margin:0; padding:10px; border:1px solid #ddd; border-radius:5px;">
                    <select name="date" onchange="this.form.submit()" style="margin:0; width: auto; border:1px solid #ddd; border-radius:5px;">
                        <option value="">Todo Período</option>
                        <option value="today">Hoje</option>
                        <option value="week">Semana</option>
                        <option value="month">Mês</option>
                    </select>
                </form>
                <a href="#" id="exportBtn" class="btn-main" style="text-decoration:none; font-size: 0.9rem; padding: 10px 20px;">
                    <i class="fas fa-download"></i> Exportar
                </a>
            </div>

            <div id="dashboard" class="tab-content active">
                <div class="stat-grid">
                    <div class="admin-card">
                        <div class="icon-box" style="background:#e0e7ff; color:#667eea;"><i class="fas fa-eye"></i></div>
                        <div><h3>{{ total_visits }}</h3><p>Visitas</p></div>
                    </div>
                    <div class="admin-card">
                        <div class="icon-box" style="background:#dcfce7; color:#16a34a;"><i class="fas fa-user-plus"></i></div>
                        <div><h3>{{ leads|length }}</h3><p>Leads</p></div>
                    </div>
                    <div class="admin-card">
                        <div class="icon-box" style="background:#fffac8; color:#f59f00;"><i class="fas fa-star"></i></div>
                        <div><h3>{{ reviews|length }}</h3><p>Avaliações</p></div>
                    </div>
                    <div class="admin-card">
                        <div class="icon-box" style="background:#fce7f3; color:#db2777;"><i class="fas fa-shopping-cart"></i></div>
                        <div><h3>{{ orders|length }}</h3><p>Vendas</p></div>
                    </div>
                </div>

                <div class="charts-container">
                    <div class="glass-card" style="flex: 2; height: 400px; position: relative;">
                        <h3 style="margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">Leads (Timeline)</h3>
                        <canvas id="leadsChart"></canvas>
                    </div>
                    <div class="glass-card" style="flex: 1; height: 400px; position: relative;">
                        <h3 style="margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">Vendas</h3>
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="chat" class="tab-content">
                <div class="messenger">
                    <div class="chat-list">
                        {% for sess in sessions %}
                        <div class="chat-item {% if sess.uuid == active_session %}active{% endif %}" style="position: relative;">
                            <div onclick="window.location.href='?session_id={{ sess.uuid }}&tab=chat'" style="cursor: pointer;">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <b style="color:var(--accent);">{{ sess.full_title }}</b> 
                                    <span style="font-size:0.7em; color:#999;">{{ sess.created_at.strftime('%H:%M') }}</span>
                                </div>
                                <small style="color:var(--text-grey);">Clique para abrir</small>
                            </div>
                            
                            <button onclick="deleteTicket(event, '{{ sess.uuid }}')" title="Excluir Ticket" 
                                    style="position: absolute; right: 10px; bottom: 8px; background: none; border: none; color: #ff4444; cursor: pointer; padding: 5px;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        {% endfor %}
                        
                        {% if not sessions %}
                        <div style="padding:20px; text-align:center; color:#999;">Nenhum chamado aberto.</div>
                        {% endif %}
                    </div>

                    <div class="chat-view">
                        {% if active_session %}
                        <div class="chat-header-admin">
                            Atendimento <span>{{ active_ticket }}</span>
                        </div>
                        <div class="chat-body" id="admin-chat-body">
                            {% for msg in chat_history %}
                                <div class="message {% if msg.remetente == 'admin' %}sent{% else %}received{% endif %}">
                                    {% if msg.remetente == 'admin' %}<small>Você</small><br>{% endif %}
                                    {% if msg.tipo == 'audio' %}
                                        <audio controls src="/static/uploads/{{ msg.conteudo }}"></audio>
                                    {% elif msg.tipo == 'arquivo' %}
                                        <a href="/static/uploads/{{ msg.conteudo }}" target="_blank" style="color:inherit;"><i class="fas fa-paperclip"></i> Ver Anexo</a>
                                    {% else %}
                                        {{ msg.conteudo }}
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                        <form id="replyForm" class="reply-area">
                            <input type="hidden" name="session_id" value="{{ active_session }}">
                            <input type="hidden" name="remetente" value="admin">
                            <input type="text" name="message" placeholder="Digite sua resposta..." required>
                            <button class="btn-main"><i class="fas fa-paper-plane"></i></button>
                        </form>
                        {% else %}
                        <div style="display:flex; align-items:center; justify-content:center; height:100%; color:#aaa; flex-direction: column;">
                            <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 10px;"></i>
                            <p>Selecione um atendimento na lista lateral.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div id="leads" class="tab-content">
                <div class="glass-card" style="padding:0; overflow-x:auto;">
                    <table class="admin-table">
                        <thead><tr><th>Data</th><th>Nome</th><th>Email</th><th>Telefone</th><th>Projeto / Anexo</th></tr></thead>
                        <tbody>
                            {% for lead in leads %}
                            <tr>
                                <td>{{ lead.data.strftime('%d/%m') }}</td>
                                <td>{{ lead.nome }}</td>
                                <td>{{ lead.email }}</td>
                                <td>{{ lead.telefone }}</td>
                                <td style="font-size:0.9em;">{{ lead.projeto }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="financeiro" class="tab-content">
                <div class="glass-card" style="padding:0; overflow-x:auto;">
                    <table class="admin-table">
                        <thead><tr><th>ID</th><th>Plano</th><th>Valor</th><th>Status</th></tr></thead>
                        <tbody>
                            {% for order in orders %}
                            <tr>
                                <td>#{{ order.id[:8] }}</td>
                                <td><span class="badge" style="background:#e0e7ff; color:#4338ca;">{{ order.plano }}</span></td>
                                <td>R$ {{ order.preco }}</td>
                                <td>{{ order.status }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="reviews" class="tab-content">
                <div class="glass-card" style="padding:0; overflow-x:auto;">
                    <table class="admin-table">
                        <thead><tr><th>Nome</th><th>Empresa</th><th>Nota</th><th>Texto</th></tr></thead>
                        <tbody>
                            {% for rev in reviews %}
                            <tr>
                                <td>{{ rev.nome }}</td>
                                <td>{{ rev.empresa }}</td>
                                <td style="color: gold;">{% for i in range(rev.estrelas) %}<i class="fas fa-star"></i>{% endfor %}</td>
                                <td>{{ rev.avaliacao }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <script>
        function openTab(evt, tabName) {
            var tabcontent = document.getElementsByClassName("tab-content");
            for (var i = 0; i < tabcontent.length; i++) tabcontent[i].style.display = "none";
            
            var navbtns = document.getElementsByClassName("nav-btn");
            for (var i = 0; i < navbtns.length; i++) navbtns[i].classList.remove("active");
            
            document.getElementById(tabName).style.display = "block";
            if(evt) evt.currentTarget.classList.add("active");
            
            localStorage.setItem('activeTab', tabName);
            updateExportBtn(tabName);
        }

        function updateExportBtn(tab) {
            const btn = document.getElementById('exportBtn');
            let type = 'leads';
            if(tab === 'financeiro') type = 'financeiro';
            if(tab === 'reviews') type = 'reviews';
            
            btn.href = `/admin/export/${type}`;
            btn.innerHTML = `<i class="fas fa-download"></i> Exportar ${type.charAt(0).toUpperCase() + type.slice(1)}`;
        }

        async function deleteTicket(event, uuid) {
            event.stopPropagation(); 
            if(!confirm("Tem certeza que deseja apagar este histórico permanentemente?")) return;
            
            try {
                const res = await fetch(`/delete_ticket/${uuid}`, { method: 'DELETE' });
                const data = await res.json();
                if(data.status === 'success') location.reload();
                else alert("Erro ao excluir");
            } catch(e) { alert("Erro de conexão"); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const activeTab = new URLSearchParams(window.location.search).get('tab') || localStorage.getItem('activeTab') || 'dashboard';
            
            const btn = document.querySelector(`button[onclick*="'${activeTab}'"]`);
            if(btn) openTab({currentTarget: btn}, activeTab);
            else openTab(null, 'dashboard');

            const leadsData = JSON.parse('{{ leads_chart|safe }}');
            const salesData = JSON.parse('{{ sales_chart|safe }}');

            if(document.getElementById('leadsChart')) {
                new Chart(document.getElementById('leadsChart'), {
                    type: 'line',
                    data: { labels: leadsData.labels, datasets: [{ label: 'Novos Leads', data: leadsData.values, borderColor: '#764ba2', fill: true, backgroundColor: 'rgba(118, 75, 162, 0.1)' }] },
                    options: { maintainAspectRatio: false }
                });
            }
            if(document.getElementById('salesChart')) {
                new Chart(document.getElementById('salesChart'), {
                    type: 'doughnut',
                    data: { labels: salesData.labels, datasets: [{ data: salesData.values, backgroundColor: ['#c0c0c0', '#ffd700', '#e0115f'] }] },
                    options: { maintainAspectRatio: false }
                });
            }

            {% if active_session %}
            setInterval(async () => {
                const res = await fetch('/get_messages/{{ active_session }}');
                const msgs = await res.json();
                const chatBody = document.getElementById('admin-chat-body');
                chatBody.innerHTML = ''; 
                msgs.forEach(m => {
                    let c = m.conteudo;
                    if(m.tipo === 'audio') c = `<audio controls src="/static/uploads/${c}"></audio>`;
                    if(m.tipo === 'arquivo') c = `<a href="/static/uploads/${c}" target="_blank">Ver Anexo</a>`;
                    
                    const div = document.createElement('div');
                    div.className = `message ${m.remetente === 'admin' ? 'sent' : 'received'}`;
                    div.innerHTML = c;
                    chatBody.appendChild(div);
                });
            }, 3000); 

            document.getElementById('replyForm').addEventListener('submit', async(e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                await fetch('/send_chat', {method:'POST', body:fd});
                e.target.reset();
            });
            {% endif %}
        });
    </script>
</body>
</html>